#! ansible-playbook -K
---
- name: Bootstrap the base image
  hosts: localhost
  connection: local
  become: yes
  tasks:
  - name: Ensure libvirt packages are installed
    package:
      name: "{{ item }}"
      state: present
    with_items:
    - libvirt
    - libvirt-daemon-kvm
    - libvirt-python

  - name: Ensure libvirt daemon is started
    systemd:
      name: libvirtd
      state: started
      enabled: yes

  - name: Get list of VMs
    virt:
      command: list_vms
      uri: "{{ qemu_uri }}"
    register: vm_list

  - when: base_host_name not in vm_list.list_vms
    block:
    - name: Ensure the thin pool is present
      lvol:
        lv: "{{ virt_thin_pool }}"
        vg: "{{ volume_group }}"
        size: 150G
        state: present
        opts: -T

    - name: Ensure base image lv is present
      lvol:
        lv: "{{ base_host_name }}"
        vg: "{{ volume_group }}"
        size: 10G
        state: present
        opts: -T -V25G --thinpool "{{ virt_thin_pool }}"
