#! ansible-playbook -K
---
- name: Bootstrap the base image
  hosts: localhost
  connection: local
  become: yes
  tasks:
  - name: Copy the repo file
    copy:
      src: base_repos
      dest: /etc/yum.repos.d/rhel7.repo

  - name: Ensure libvirt packages are installed
    package:
      name: "{{ item }}"
      state: present
    with_items:
    - libvirt
    - libvirt-daemon-kvm
    - libvirt-python
    - virt-install
    - qemu-kvm-rhev
    - qemu-img-rhev

  - name: Ensure libvirt daemon is started
    systemd:
      name: libvirtd
      state: started
      enabled: yes

  - name: Get the state of the smt setting
    command: ppc64_cpu --smt
    register: smt_setting
    changed_when: false

  - name: Turn the smt setting off if needed
    command: ppc64_cpu --smt=off
    when: "'SMT is off' not in smt_setting.stdout"
    register: update_smt

  - name: Restart libvirt
    systemd:
      name: libvirtd
      state: restarted
    when: update_smt|changed


  - name: Get list of VMs
    virt:
      command: list_vms
      uri: "{{ qemu_uri }}"
    register: vm_list

  - when: base_host_name not in vm_list.list_vms
    block:
    - name: Ensure the thin pool is present
      lvol:
        lv: "{{ base_host_name }}"
        vg: "{{ volume_group }}"
        size: 150G
        state: present
        opts: "--type thin -V 25G -T --thinpool {{ virt_thin_pool }}"

    - name: Install the VM
      command: >
        virt-install --name {{ base_host_name }}
        --vcpus=24 --ram=4096
        --os-type=linux --os-variant=rhel7
        --controller type=scsi,model=virtio-scsi
        --location=http://download-node-02.eng.bos.redhat.com/composes/released/RHEL-7/7.3/Server/ppc64le/os/
        --disk path=/dev/{{ volume_group }}/{{ base_host_name }},cache=none,io=native,discard=unmap,bus=scsi
        --network=default
        --nographics
        --extra-args="console=tty0 console=ttyS0,115200n8"

    - name: Pause until VM install completed
      pause:
