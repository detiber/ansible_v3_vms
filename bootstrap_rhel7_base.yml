#! ansible-playbook -K
---
- name: Bootstrap the base image
  hosts: localhost
  connection: local
  become: yes
  tasks:
  - name: Copy the repo file
    copy:
      src: host_repos
      dest: /etc/yum.repos.d/rhel7.repo

  - name: Get the state of the smt setting
    command: ppc64_cpu --smt
    register: smt_setting
    changed_when: false

  - name: Turn the smt setting off if needed
    command: ppc64_cpu --smt=off
    when: "'SMT is off' not in smt_setting.stdout"
    register: update_smt

  - name: Ensure libvirt packages are installed
    package:
      name: "{{ item }}"
      state: present
    with_items:
    - libvirt
    - libvirt-daemon-kvm
    - libvirt-python
    - virt-install
    - qemu-kvm-rhev
    - qemu-img-rhev

  - name: Ensure libvirt daemon is started
    systemd:
      name: libvirtd
      state: started
      enabled: yes

  - name: Get list of VMs
    virt:
      command: list_vms
      uri: "{{ qemu_uri }}"
    register: vm_list

  - when: base_host_name not in vm_list.list_vms
    block:
    - name: Ensure the thin pool is present
      lvol:
        lv: "{{ virt_thin_pool }}"
        vg: "{{ volume_group }}"
        size: 150G
        state: present
        opts: -T

    - name: Test for base lv
      command: "lvs {{ volume_group }}/{{ base_host_name }}"
      register: base_lv
      failed_when: false
      changed_when: false

    - name: Create base lv if needed
      command: >
        lvcreate -T -V25G --thinpool {{ virt_thin_pool }}
        -n {{ base_host_name }} {{ volume_group }}
      when: base_lv.rc != 0

    - name: Copy the kickstart file
      copy:
        src: ks-base.cfg
        dest: /tmp/ks-base.cfg

    - name: Install the VM
      command: >
        virt-install --name {{ base_host_name }}
        --vcpus=24 --ram=4096
        --os-type=linux --os-variant=rhel7
        --controller type=scsi,model=virtio-scsi
        --location=http://download-node-02.eng.bos.redhat.com/composes/released/RHEL-7/7.3/Server/ppc64le/os/
        --disk path=/dev/{{ volume_group }}/{{ base_host_name }},cache=none,io=native,discard=unmap,bus=scsi
        --network=default
        --nographics
        --initrd-inject /tmp/ks-base.cfg
        --extra-args="inst.ks=file:/ks-base.cfg ip=dhcp console=tty0 console=ttyS0,115200n8"

    - name: Pause until VM install completed
      pause:
