#! ansible-playbook -K
---
- name: Bootstrap the base image
  hosts: localhost
  connection: local
  become: yes
  vars:
    kvm_snapshot_base_os: rhel7
  pre_tasks:
  - assert:
      msg: kvm_snapshot_cluster_id is required
      that:
      - kvm_snapshot_cluster_id is defined

  - assert:
      msg: "kvm_snapshot_base_os is required and must be one of: rhel7,centos7,fedora25"
      that:
      - kvm_snapshot_base_os | default('') in ['rhel7', 'centos7', 'fedora25']
  roles:
  - kvm_snapshot_cluster

- hosts: all
  vars:
    guest_repos:
      RedHat:
        ppc64le:
        - id: rhel7-base
          name: RHEL 7 Base OS
          baseurl: http://download.eng.bos.redhat.com/nightly/RHEL-7.4-20170607.n.0/compose/Server/ppc64le/os
        - id: rhel7-extras
          name: RHEL 7 Extras
          baseurl: http://download-node-02.eng.bos.redhat.com/devel/candidate-trees/EXTRAS-7.4-RHEL-7-20170526.0/compose/Server/ppc64le/os/
        - id: fastdatapath
          name: fastdatapath
          baseurl: http://download-node-02.eng.bos.redhat.com/brewroot/repos/fast-datapath-rhel-7-newarches-build/latest/ppc64le/
        x86_64:
        - id: rhel7-base
          name: RHEL 7 Base OS
          baseurl: http://pulp.dist.prod.ext.phx2.redhat.com/content/dist/rhel/server/7/7Server/x86_64/os/
        - id: rhel7-extras
          name: RHEL 7 Extras
          baseurl: http://pulp.dist.prod.ext.phx2.redhat.com/content/dist/rhel/server/7/7Server/x86_64/extras/os/
        - id: fastdatapath
          name: fastdatapath
          baseurl: http://pulp.dist.prod.ext.phx2.redhat.com/content/dist/rhel/server/7/7Server/x86_64/fast-datapath/os/
      Fedora:
        ppc64le: []
        x86_64: []
  handlers:
  - name: Restart Docker
    systemd:
      name: docker
      state: restarted
    when: docker_stat.stat.exists
  tasks:
  - name: Test if docker present
    stat:
      path: /usr/bin/docker
    register: docker_stat

  - yum_repository:
      name: "{{ item.id }}"
      description: "{{ item.name }}"
      baseurl: "{{ item.baseurl }}"
      gpgcheck: no
    with_items:
    - "{{ guest_repos[ansible_distribution][ansible_architecture] }}"

  - name: Install the Red Hat CA
    package:
      name: http://hdn.corp.redhat.com/rhel7-csb-stage/RPMS/noarch/redhat-internal-cert-install-0.1-7.el7.csb.noarch.rpm
      state: present
    notify: Restart Docker

- include: /tmp/openshift-ansible/playbooks/byo/openshift-cluster/config.yml
  vars:
    cluster_deployment_type: openshift-enterprise
    cluster_version: 3.5
    cluster_repo:
      3.5:
        RedHat:
          ppc64le: http://download-node-02.eng.bos.redhat.com/brewroot/repos/rhaos-3.5-rhel-7-newarches-build/latest/ppc64le
    os_firewall_use_firewalld: True
    openshift_deployment_type: "{{ cluster_deployment_type }}"
    oreg_url: "{{ '' if ansible_architecture == 'x86_64' else 'docker-registry.engineering.redhat.com/multi-arch/ppc64le-openshift3-ose-${component}:${version}' }}"
    openshift_cockpit_deployer_prefix: "{{ '' if ansible_architecture == 'x86_64' else 'docker-registry.engineering.redhat.com/multi-arch/ppc64le-openshift3-' }}"
    openshift_cockpit_deployer_version: "{{ '' if ansible_architecture == 'x86_64' else 'v3.5-12' }}"
    openshift_additional_repos:
    - id: rhaos
      name: rhaos
      baseurl: "{{ cluster_repo[cluster_version][ansible_distribution][ansible_architecture] }}"
      gpgcheck: 0
      enabled: 1
