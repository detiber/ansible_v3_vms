#! ansible-playbook -K
---
- name: Bootstrap the base image
  hosts: localhost
  connection: local
  become: yes
  vars:
    kvm_snapshot_cluster_id: test
    kvm_snapshot_cluster_bridge: virbr1
    kvm_snapshot_cluster_cidr: 192.168.144.0/24
    kvm_snapshot_cluster_parent_domain: example.com
  roles:
  - kvm_snapshot_cluster

- hosts: all
  handlers:
  - name: Restart Docker
    systemd:
      name: docker
      state: restarted
    when: docker_stat.stat.exists
  tasks:
  - name: Test if docker present
    stat:
      path: /usr/bin/docker
    register: docker_stat

  - yum_repository:
      name: rhel7-base
      description: RHEL 7 Base OS
      baseurl: http://download.eng.bos.redhat.com/nightly/RHEL-7.4-20170607.n.0/compose/Server/ppc64le/os
      gpgcheck: no

  - yum_repository:
      name: rhel7-extras
      description: RHEL 7 Extras
      baseurl: http://download-node-02.eng.bos.redhat.com/devel/candidate-trees/EXTRAS-7.4-RHEL-7-20170526.0/compose/Server/ppc64le/os/
      gpgcheck: no

  - name: Install the Red Hat CA
    package:
      name: http://hdn.corp.redhat.com/rhel7-csb-stage/RPMS/noarch/redhat-internal-cert-install-0.1-7.el7.csb.noarch.rpm
      state: present
    notify: Restart Docker

- include: /tmp/openshift-ansible/playbooks/byo/openshift-cluster/config.yml
  vars:
    openshift_deployment_type: openshift-enterprise
    os_firewall_use_firewalld: True
    oreg_url: docker-registry.engineering.redhat.com/multi-arch/ppc64le-openshift3-ose-${component}:${version}
    openshift_cockpit_deployer_prefix: docker-registry.engineering.redhat.com/multi-arch/ppc64le-openshift3-ose-
    openshift_additional_repos:
    - id: rhaos-multiarch
      name: rhaos-multiarch
      baseurl: http://download-node-02.eng.bos.redhat.com/brewroot/repos/rhaos-3.5-rhel-7-newarches-build/latest/ppc64le/
      gpgcheck: 0
      enabled: 1
    - id: fastdatapath-multiarch
      name: fastdatapath-multiarch
      baseurl: http://download-node-02.eng.bos.redhat.com/brewroot/repos/fast-datapath-rhel-7-newarches-build/latest/ppc64le/
      gpgcheck: 0
      enabled: 1
